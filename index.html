<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>RafidMath5 – قياس ناتج التعلم</title>
<style>
  :root{--b:#d9dde3;--bg:#fff;--muted:#666;--accent:#0b5cad}
  *{box-sizing:border-box}
  body{margin:0;background:#f6f7f9;font-family:"Tahoma","Cairo",system-ui}
  .wrap{max-width:1100px;margin:28px auto;padding:16px;background:#fff;border:1px solid var(--b);border-radius:10px}
  header{border-bottom:1px solid var(--b);padding-bottom:12px;margin-bottom:14px}
  h1{margin:0;text-align:center}
  .student-grid{display:grid;grid-template-columns:1fr 1fr 1fr;gap:10px;margin-top:12px}
  .field{display:flex;flex-direction:column;gap:6px}
  .field label{font-size:12px;color:#222}
  input,select,textarea{border:1px solid var(--b);border-radius:8px;padding:10px;background:#fff;font-size:14px}
  .grid{display:grid;grid-template-columns:repeat(4,1fr);gap:10px;margin:16px 0 6px}
  .qbox{margin-top:8px}
  .q-actions{display:flex;gap:8px;align-items:center;margin-top:6px}
  .q-actions .meta{font-size:12px;color:var(--muted)}
  .toolbar{display:flex;flex-wrap:wrap;gap:8px;margin:14px 0}
  .btn{border:1px solid var(--b);background:#fff;border-radius:8px;padding:10px 14px;cursor:pointer}
  .btn.primary{background:var(--accent);color:#fff;border-color:var(--accent)}
  table{width:100%;border-collapse:collapse;background:#fff}
  th,td{border:1px solid var(--b);padding:10px;vertical-align:top}
  th{background:#f0f4f8}
  .meta{font-size:12px;color:var(--muted)}
  @media (max-width:900px){.grid{grid-template-columns:1fr 1fr}}
  @media (max-width:560px){.grid,.student-grid{grid-template-columns:1fr}}
  @media print{
    body{background:#fff}
    .wrap{border:none;margin:0;max-width:none;border-radius:0}
    .toolbar,.q-actions{display:none}
    th{background:#eaeaea!important;-webkit-print-color-adjust:exact;print-color-adjust:exact}
  }
</style>
</head>
<body>
<div class="wrap">
  <header>
    <h1>قياس ناتج التعلم</h1>
    <div class="student-grid" aria-label="بيانات الطالب">
      <div class="field">
        <label for="studentName">اسم الطالب</label>
        <input id="studentName" placeholder="مثال: محمد أحمد">
      </div>
      <div class="field">
        <label for="className">الصف/الشعبة</label>
        <input id="className" placeholder="مثال: 5/أ">
      </div>
      <div class="field">
        <label for="dateVal">التاريخ</label>
        <input id="dateVal" type="date">
      </div>
    </div>
  </header>

  <div class="grid" aria-label="اختيارات مترابطة">
    <div class="field">
      <label for="unitSel">الفصل</label>
      <select id="unitSel"></select>
    </div>
    <div class="field">
      <label for="lessonSel">الدرس</label>
      <select id="lessonSel"></select>
    </div>
    <div class="field">
      <label for="loSel">ناتج التعلم</label>
      <select id="loSel"></select>
    </div>
    <div class="field">
      <label for="indSel">المؤشر</label>
      <select id="indSel"></select>
    </div>
  </div>

  <div class="qbox">
    <div class="field">
      <label for="qTxt">السؤال</label>
      <textarea id="qTxt" placeholder="اكتب السؤال أو الصقه هنا"></textarea>
    </div>
    <div class="q-actions">
      <label class="btn">استيراد سؤال من ملف
        <input id="qFile" type="file" accept=".txt,.md,.rtf,.html,text/plain" style="display:none">
      </label>
      <span class="meta">يدعم ملفات نصيّة. سيتم إدراج محتواها مباشرة في خانة السؤال.</span>
    </div>
  </div>

  <div class="toolbar">
    <button class="btn primary" onclick="addRow()">+ إضافة صف</button>
    <button class="btn" onclick="save()">حفظ</button>
    <button class="btn" onclick="load()">استرجاع</button>
    <button class="btn" onclick="exportJSON()">تصدير JSON</button>
    <label class="btn">استيراد JSON
      <input type="file" accept="application/json" style="display:none" onchange="importJSON(this.files[0])">
    </label>
    <button class="btn" onclick="window.print()">طباعة / PDF</button>
    <span class="meta" id="savedAt"></span>
  </div>

  <table id="grid">
    <thead>
      <tr>
        <th>اسم الطالب</th>
        <th>الصف</th>
        <th>التاريخ</th>
        <th>الفصل</th>
        <th>الدرس</th>
        <th>ناتج التعلم</th>
        <th>المؤشر</th>
        <th>السؤال</th>
      </tr>
    </thead>
    <tbody></tbody>
  </table>

  <p class="meta">اختر الفصل ثم الدرس ثم ناتج التعلم ثم المؤشر. أضف سؤالك ثم “إضافة صف”.</p>
</div>

<script>
/* ========= DATA: النصوص الكاملة كما في الصور ========= */
const DATA = {
"الفصل 1: القيمة المنزلية": {lessons:{
  "القيمة المنزلية ضمن البلايين":{
    learningOutcomes:[
      "ناتج التعلّم (1): وصف الأعداد ضمن 12 منزلة، وتمثيل هذه الأعداد، وقراءتها، وكتابتها، والمقارنة بينها، وترتيبها، وتقديرها."
    ],
    indicators:[
      "المؤشر 1-1: يميز القيمة المنزلية لرقم في عدد ضمن 12 منزلة، ويمثل الأعداد باستخدام الرسوم وخط الأعداد، ويُقدِّرُ إلى أقرب منزلة مُعطاة.",
      "المؤشر 1-2: يقرأ الأعداد ضمن 12 منزلة، ويكتبها في الصور القياسية، واللفظية، والتحليلية."
    ]
  },
  "المقارنة بين الأعداد":{
    learningOutcomes:[
      "ناتج التعلّم (1): وصف الأعداد ضمن 12 منزلة، وتمثيل هذه الأعداد، وقراءتها، وكتابتها، والمقارنة بينها، وترتيبها، وتقديرها."
    ],
    indicators:[
      "المؤشر 1-3: يقارن بين الأعداد ضمن 12 منزلة باستخدام الرموز ( < ، > ، = )، ويرتبها تصاعدياً وتنازلياً."
    ]
  },
  "تمثيل الكسور العشرية":{
    learningOutcomes:[
      "ناتج التعلّم (2): وصف الكسور العشرية، وتمثيلها، وتمييز القيمة المنزلية لرقم فيها، وقراءتها، وكتابتها، والمقارنة بينها وترتيبها، وتقديرها، والتحويل بينها وبين الكسور الاعتيادية والأعداد الكسرية."
    ],
    indicators:[
      "المؤشر 2-2: يصف الكسر العشري، ويمثله باستخدام النماذج، والرسوم، وخط الأعداد، ويميز القيمة المنزلية لرقم فيه، فيقرأه ويكتبه، ويمثل هذه الأعداد كنِسَب مئوية، ويحوِّلها.",
      "المؤشر 2-3: يقرأ الكسور العشرية، ويكتبها في الصور القياسية، واللفظية، والتحليلية."
    ]
  },
  "القيمة المنزلية ضمن أجزاء الألف":{
    learningOutcomes:[
      "ناتج التعلّم (2): وصف الكسور العشرية، وتمثيلها، وتمييز القيمة المنزلية لرقم فيها، وقراءتها، وكتابتها، والمقارنة بينها وترتيبها، وتقديرها، والتحويل بينها وبين الكسور الاعتيادية والأعداد الكسرية."
    ],
    indicators:[
      "المؤشر 2-4: يقارن بين الكسور العشرية، ويرتبها تصاعدياً وتنازلياً."
    ]
  },
  "مقارنة الكسور العشرية":{
    learningOutcomes:[
      "ناتج التعلّم (2): وصف الكسور العشرية، وتمثيلها… والمقارنة بينها وترتيبها."
    ],
    indicators:[
      "المؤشر 1-4: يقارن بين الكسور العشرية، ويرتبها تصاعدياً وتنازلياً."
    ]
  },
  "ترتيب الأعداد والكسور العشرية":{
    learningOutcomes:[
      "ناتج التعلّم (1): وصف الأعداد ضمن 12 منزلة… وترتيبها وتقديرها.",
      "ناتج التعلّم (2): وصف الكسور العشرية… وترتيبها وتقديرها."
    ],
    indicators:[
      "المؤشر 1-3: يقارن ويرتب الأعداد.",
      "المؤشر 2-4: يقارن ويرتب الكسور العشرية."
    ]
  }
}},
"الفصل 2: الجمع والطرح": {lessons:{
  "تقريب الأعداد والكسور العشرية":{
    learningOutcomes:[
      "ناتج التعلّم (2): وصف الكسور العشرية، وتمثيلها، وتمييز القيمة المنزلية لرقم فيها، وقراءتها، وكتابتها، والمقارنة بينها وترتيبها، وتقديرها، والتحويل بينها وبين الكسور الاعتيادية والأعداد الكسرية."
    ],
    indicators:[
      "المؤشر 2-3: يصف الكسر العشري، ويمثله باستخدام النماذج، والرسوم، وخط الأعداد، ويميِّز القيمة المنزلية لرقم فيه، فيقرأه ويكتبه، ويمثل هذه الأعداد كنِسَب مئوية، ويحوِّلها."
    ]
  },
  "تقدير نواتج الجمع والطرح":{
    learningOutcomes:[
      "ناتج التعلّم (9): جمع الكسور العشرية، وطرحها، وقسمتها، واستخدامها في حل مسائل رياضية.",
      "ناتج التعلّم (10): تقدير نواتج العمليات الأربع على الأعداد الكلية، والكسور، واستخدام الحساب الذهني."
    ],
    indicators:[
      "المؤشر 10-1: يقدِّر نواتج جمع الأعداد الكلية، والكسور، والكسور العشرية، وطرحها، وضربها، وقسمتها باستخدام التقريب أو الأعداد المتنامية."
    ]
  },
  "جمع الكسور العشرية وطرحها":{
    learningOutcomes:[
      "ناتج التعلّم (9): جمع الكسور العشرية، وطرحها، وقسمتها، واستخدامها في حل مسائل رياضية."
    ],
    indicators:[
      "المؤشر 9-8: يجمع الكسور العشرية حتى الجزء من ألف، ويطرحها، ويقسمها.",
      "المؤشر 9-9: يجعل مسائل رياضية من ثلاث خطوات على الأكثر تتضمن تطبيقات حياتية على العمليات الأربع على الكسور العشرية، ويفسِّر حلها."
    ]
  }
}},
"الفصل 3: الضرب": {lessons:{
  "أنماط الضرب":{
    learningOutcomes:[
      "ناتج التعلّم (4): جمع الأعداد الكلية ضمن سبع منازل، وطرحها، وضرب الأعداد من ثلاث منازل على الأكثر، وقسمتها على عدد من منزلتين على الأكثر، واستخدامها في حل مسائل رياضية."
    ],
    indicators:[
      "المؤشر 3-1: يستخدم الحساب الذهني لإيجاد حاصل ضرب عدد من منزلتين على الأكثر، وقسمته، وعلى مضاعفات (10، 100، 1000…)."
    ]
  },
  "خاصية التوزيع":{
    learningOutcomes:[
      "ناتج التعلّم (4): جمع الأعداد الكلية ضمن سبع منازل، وطرحها، وضرب الأعداد…"
    ],
    indicators:[
      "المؤشر 3-2: يستخدم خاصية التوزيع لضرب عدد من منزلتين في عدد من منزلة واحدة ذهنيًا."
    ]
  },
  "تقدير نواتج الضرب":{
    learningOutcomes:[
      "ناتج التعلّم (10): تقدير نواتج العمليات الأربع على الأعداد الكلية، والكسور، واستخدام الحساب الذهني."
    ],
    indicators:[
      "المؤشر 10-1: يقدِّر نواتج جمع الأعداد الكلية، والكسور… باستخدام التقريب أو الأعداد المتنامية."
    ]
  },
  "الضرب في عدد من رقم واحد":{
    learningOutcomes:[
      "ناتج التعلّم (4): …"
    ],
    indicators:[
      "المؤشر 4-2: يضرب عددًا من ثلاث منازل على الأكثر في عدد من منزلتين على الأكثر (دون ومع إعادة التجميع) باستخدام الاستراتيجيات المعتمدة على القيمة المنزلية."
    ]
  },
  "الضرب في عدد من رقمين":{
    learningOutcomes:[
      "ناتج التعلّم (4): …"
    ],
    indicators:[
      "المؤشر 4-3: يضرب عددًا من ثلاث منازل على الأكثر في عدد من منزلتين على الأكثر (دون ومع إعادة التجميع) باستخدام الاستراتيجيات المعتمدة على القيمة المنزلية."
    ]
  },
  "استقصاء: حل المسألة":{
    learningOutcomes:[
      "ناتج التعلّم (10): تقدير نواتج العمليات الأربع على الأعداد الكلية، والكسور، واستخدام الحساب الذهني."
    ],
    indicators:[
      "المؤشر 4-4: يجعل مسائل رياضية من ثلاث خطوات على الأكثر تتضمن تطبيقات حياتية على العمليات الأربع، ويفسِّر حلها."
    ]
  }
}},
"الفصل 4: القسمة": {lessons:{
  "أنماط القسمة":{
    learningOutcomes:[
      "ناتج التعلّم (4): جمع الأعداد الكلية ضمن سبع منازل، وطرحها، وضربها، وقسمتها…"
    ],
    indicators:[
      "المؤشر 4-1: يستخدم الحساب الذهني لإيجاد حاصل ضرب عدد من منزلتين على الأكثر، وقسمته، وعلى مضاعفات (10، 100، 1000…)."
    ]
  },
  "القسمة على عدد من رقم واحد":{
    learningOutcomes:[
      "ناتج التعلّم (10): تقدير نواتج العمليات الأربع على الأعداد الكلية، والكسور، واستخدام الحساب الذهني."
    ],
    indicators:[
      "المؤشر 4-2: يقسم عددًا من أربع منازل على الأكثر على عدد من منزلتين على الأكثر باستخدام الاستراتيجيات المعتمدة على القيمة المنزلية (دون ومع إعادة التجميع)."
    ]
  },
  "القسمة على عدد من رقمين":{
    learningOutcomes:[
      "ناتج التعلّم (10): تقدير نواتج العمليات الأربع على الأعداد الكلية، والكسور، واستخدام الحساب الذهني."
    ],
    indicators:[
      "المؤشر 4-3: يقسم عددًا من أربع منازل على الأكثر على عدد من منزلتين على الأكثر باستخدام الاستراتيجيات المعتمدة على القيمة المنزلية (دون ومع إعادة التجميع)."
    ]
  },
  "خطة حل المسألة (تمثيل المعطيات)":{
    learningOutcomes:[
      "ناتج التعلّم (10): تقدير نواتج العمليات الأربع على الأعداد الكلية، والكسور، واستخدام الحساب الذهني."
    ],
    indicators:[
      "المؤشر 4-4: يجعل مسائل رياضية من ثلاث خطوات على الأكثر تتضمن تطبيقات حياتية على العمليات الأربع، ويفسِّر حلها."
    ]
  }
}},
"الفصل 5: العبارات الجبرية والمعادلات": {lessons:{
  "عبارات الجمع والطرح الجبرية":{
    learningOutcomes:[
      "ناتج التعلّم (11): تمييز أنماط عددية، وهندسية متنامية، والعلاقة في جدول، ووصفها، وتوسيعها، واستخدامها في حل مسائل رياضية."
    ],
    indicators:[
      "المؤشر 12-1: يصف العبارة الجبرية، ويكتبها، بحيث تتضمن عمليتين على الأكثر مع استخدام الأقواس، ويُوجد قيمها باستخدام ترتيب العمليات.",
      "المؤشر 12-2: يجعل مسائل رياضية تتضمن تطبيقات حياتية على العبارات العددية والجبرية، والمعادلات الخطية البسيطة، ويفسِّر حلها."
    ]
  },
  "خطة حل المسألة (أبسط)":{
    learningOutcomes:[
      "ناتج التعلّم (11): تمييز أنماط عددية… ووصفها وتوسيعها…"
    ],
    indicators:[
      "المؤشر 12-3: يصف العبارة الجبرية، ويكتبها، ويكمل العناصر المفقودة فيها، ويكوِّنها، ويعمِّمها."
    ]
  },
  "عبارات الضرب والقسمة الجبرية":{
    learningOutcomes:[
      "ناتج التعلّم (12): وصف العبارات العددية والجبرية، وتمييز المعادلة الخطية البسيطة، وكتابتها، وإيجاد قيمها، واستخدامها في حل مسائل رياضية."
    ],
    indicators:[
      "المؤشر 12-4: يميِّز المعادلة الخطية البسيطة (ذات الخطوة الواحدة)، ويكتبها."
    ]
  },
  "استقصاء حل المسألة":{
    learningOutcomes:[
      "ناتج التعلّم (12): …"
    ],
    indicators:[
      "المؤشر 12-5: يجعل مسائل رياضية تتضمن تطبيقات حياتية على العبارات العددية، والجبرية، والمعادلات الخطية البسيطة، ويفسِّر حلها."
    ]
  },
  "جداول الدوال":{
    learningOutcomes:[
      "ناتج التعلّم (12): وصف العبارات العددية والجبرية… واستخدامها في حل مسائل."
    ],
    indicators:[
      "المؤشر 11-1: يربط العلاقة بين مجموعتين من البيانات في جدول الدوال، ويكتب المدخلات، والمخرجات، والرموز، ويبيِّن فيه التغير الأحادي.",
      "المؤشر 11-2: يكوِّن جدول المدخلات والمخرجات، ويكمله، وفق قاعدة مُعطاة، ويتضمن عمليتين على الأكثر."
    ]
  },
  "ترتيب العمليات":{
    learningOutcomes:[
      "ناتج التعلّم (12): …"
    ],
    indicators:[
      "المؤشر 12-6: يصف العبارة الجبرية، ويكتبها، بحيث تتضمن عمليتين على الأكثر مع استخدام الأقواس، ويُوجد قيمها باستخدام ترتيب العمليات."
    ]
  },
  "معادلات الجمع والطرح":{
    learningOutcomes:[
      "ناتج التعلّم (12): …"
    ],
    indicators:[
      "المؤشر 12-7: يكتب معادلة خطية بسيطة ذهنيًا وكتابيًا باستخدام النماذج، ويتحقق من صحة الحل."
    ]
  }
}},
"الفصل 6: الكسور الاعتيادية": {lessons:{
  "القسمة والكسور الاعتيادية":{
    learningOutcomes:[
      "ناتج التعلّم (2): تمييز الكسور الاعتيادية، والأعداد الكسرية، والكسور غير الفعلية، وتمثيلها، وقراءتها، وكتابتها، والمقارنة بينها، وترتيبها، وتقديرها."
    ],
    indicators:[
      "المؤشر 2-1: يميز الكسر الاعتيادي، ويمثله باستخدام النماذج، والرسوم، وخط الأعداد، ويقرؤه، ويكتبه."
    ]
  },
  "الكسور غير الفعلية":{
    learningOutcomes:[
      "ناتج التعلّم (2): تمييز الكسور الاعتيادية، والأعداد الكسرية، والكسور غير الفعلية…"
    ],
    indicators:[
      "المؤشر 2-3: يميز العدد الكسري، ويمثله باستخدام النماذج، والرسوم، وخط الأعداد، ويقرؤه، ويكتبه."
    ]
  },
  "تقريب الكسور":{
    learningOutcomes:[
      "ناتج التعلّم (2): تمييز الكسور الاعتيادية… وكتابتها، والمقارنة بينها، وترتيبها، وتقديرها."
    ],
    indicators:[
      "المؤشر 2-2: يميز الكسور الاعتيادية، ويمثلها باستخدام النماذج، والرسوم، وخط الأعداد، ويقرؤها، ويكتبها.",
      "المؤشر 2-4: يوجد الكسور المكافئة لكسر، ويكتب الكسر في أبسط صورة، ويقرّبه إلى الصفر أو النصف أو الواحد."
    ]
  }
}}
};
/* ======= التخزين والواجهة ======= */
const KEY_ROWS="rafid_math5_rows_v4";
const KEY_META="rafid_math5_meta_v4";
const KEY_STAMP="rafid_math5_stamp_v4";

const unitSel=document.getElementById("unitSel");
const lessonSel=document.getElementById("lessonSel");
const loSel=document.getElementById("loSel");
const indSel=document.getElementById("indSel");
const qTxt=document.getElementById("qTxt");
const qFile=document.getElementById("qFile");
const tbody=document.querySelector("#grid tbody");
const studentName=document.getElementById("studentName");
const className=document.getElementById("className");
const dateVal=document.getElementById("dateVal");

function fillUnits(){
  unitSel.innerHTML="";
  Object.keys(DATA).forEach(u=>{
    const o=document.createElement("option");o.value=o.textContent=u;unitSel.appendChild(o);
  });
}
function fillLessons(){
  const unit=unitSel.value;
  lessonSel.innerHTML=""; loSel.innerHTML=""; indSel.innerHTML="";
  if(!unit) return;
  Object.keys(DATA[unit].lessons).forEach(l=>{
    const o=document.createElement("option");o.value=o.textContent=l;lessonSel.appendChild(o);
  });
  fillLOs();
}
function fillLOs(){
  const unit=unitSel.value, lesson=lessonSel.value;
  loSel.innerHTML=""; indSel.innerHTML="";
  if(!unit||!lesson) return;
  DATA[unit].lessons[lesson].learningOutcomes.forEach(lo=>{
    const o=document.createElement("option");o.value=o.textContent=lo;loSel.appendChild(o);
  });
  DATA[unit].lessons[lesson].indicators.forEach(ind=>{
    const o=document.createElement("option");o.value=o.textContent=ind;indSel.appendChild(o);
  });
}

function addRow(){
  const row={
    name: studentName.value.trim(),
    cls: className.value.trim(),
    date: dateVal.value || "",
    unit: unitSel.value,
    lesson: lessonSel.value,
    lo: loSel.value,
    ind: indSel.value,
    q: qTxt.value.trim()
  };
  const tr=document.createElement("tr");
  tr.innerHTML=`
    <td>${escapeHtml(row.name)}</td>
    <td>${escapeHtml(row.cls)}</td>
    <td>${escapeHtml(row.date)}</td>
    <td>${escapeHtml(row.unit)}</td>
    <td>${escapeHtml(row.lesson)}</td>
    <td>${escapeHtml(row.lo)}</td>
    <td>${escapeHtml(row.ind)}</td>
    <td>${escapeHtml(row.q)}</td>`;
  tbody.appendChild(tr);
  save();
  qTxt.value="";
}

function save(){
  const rows=[...tbody.querySelectorAll("tr")].map(tr=>{
    const t=[...tr.children].map(td=>td.textContent);
    return {name:t[0],cls:t[1],date:t[2],unit:t[3],lesson:t[4],lo:t[5],ind:t[6],q:t[7]};
  });
  localStorage.setItem(KEY_ROWS, JSON.stringify(rows));
  localStorage.setItem(KEY_META, JSON.stringify({
    name:studentName.value.trim(), cls:className.value.trim(), date:dateVal.value||""
  }));
  const stamp=new Date().toLocaleString('ar-SA');
  localStorage.setItem(KEY_STAMP, stamp);
  document.getElementById("savedAt").textContent="آخر حفظ: "+stamp;
}
function load(){
  tbody.innerHTML="";
  const rows=JSON.parse(localStorage.getItem(KEY_ROWS)||"[]");
  rows.forEach(r=>{
    const tr=document.createElement("tr");
    tr.innerHTML=`
      <td>${escapeHtml(r.name)}</td>
      <td>${escapeHtml(r.cls)}</td>
      <td>${escapeHtml(r.date)}</td>
      <td>${escapeHtml(r.unit)}</td>
      <td>${escapeHtml(r.lesson)}</td>
      <td>${escapeHtml(r.lo)}</td>
      <td>${escapeHtml(r.ind)}</td>
      <td>${escapeHtml(r.q)}</td>`;
    tbody.appendChild(tr);
  });
  const meta=JSON.parse(localStorage.getItem(KEY_META)||"{}");
  studentName.value=meta.name||""; className.value=meta.cls||""; dateVal.value=meta.date||"";
  const s=localStorage.getItem(KEY_STAMP)||""; document.getElementById("savedAt").textContent=s?("آخر حفظ: "+s):"";
}

function exportJSON(){
  const payload={
    meta:{name:studentName.value.trim(),cls:className.value.trim(),date:dateVal.value||""},
    rows:JSON.parse(localStorage.getItem(KEY_ROWS)||"[]")
  };
  const blob=new Blob([JSON.stringify(payload,null,2)],{type:"application/json;charset=utf-8"});
  const a=document.createElement("a"); a.href=URL.createObjectURL(blob); a.download="rafid_math5_data.json"; a.click();
  URL.revokeObjectURL(a.href);
}
function importJSON(file){
  const fr=new FileReader();
  fr.onload=e=>{
    try{
      const d=JSON.parse(e.target.result);
      localStorage.setItem(KEY_ROWS, JSON.stringify(d.rows||[]));
      localStorage.setItem(KEY_META, JSON.stringify(d.meta||{}));
      load();
    }catch{ alert("ملف JSON غير صالح"); }
  };
  fr.readAsText(file,'utf-8');
}

document.getElementById("qFile").addEventListener("change", ()=>{
  const f=qFile.files[0]; if(!f) return;
  const fr=new FileReader();
  fr.onload=e=>{ qTxt.value=(qTxt.value? qTxt.value+"\n":"")+e.target.result; };
  fr.readAsText(f,'utf-8');
});

function escapeHtml(s){return (s||"").replace(/[&<>"']/g,m=>({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[m]))}

unitSel.addEventListener("change", fillLessons);
lessonSel.addEventListener("change", fillLOs);
fillUnits(); fillLessons(); load();
</script>
</body>
</html>