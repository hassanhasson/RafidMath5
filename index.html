<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>RafidMath5 – قياس ناتج التعلم</title>
<style>
  :root{--b:#d9dde3;--bg:#fff;--muted:#666;--accent:#0b5cad}
  *{box-sizing:border-box}
  body{margin:0;background:#f6f7f9;font-family:"Tahoma","Cairo",system-ui}
  .wrap{max-width:1100px;margin:28px auto;padding:16px;background:#fff;border:1px solid var(--b);border-radius:10px}
  header{display:flex;gap:16px;align-items:flex-start;border-bottom:1px solid var(--b);padding-bottom:12px;margin-bottom:14px}
  h1{margin:0;flex:1;text-align:center}
  .student{min-width:320px;max-width:42%;background:#fafafa;border:1px solid var(--b);border-radius:8px;padding:10px}
  .student label{font-size:12px;color:var(--muted)}
  .student input{width:100%;border:1px solid var(--b);border-radius:6px;padding:8px 10px;margin-top:6px}
  .grid{display:grid;grid-template-columns:repeat(5,1fr);gap:8px}
  .field{display:flex;flex-direction:column;gap:6px}
  .field label{font-size:13px;color:#222}
  select, textarea{width:100%;border:1px solid var(--b);border-radius:8px;padding:10px;background:#fff;font-size:14px}
  textarea{min-height:48px;resize:vertical}
  .toolbar{display:flex;flex-wrap:wrap;gap:8px;margin:12px 0}
  .btn{border:1px solid var(--b);background:#fff;border-radius:8px;padding:10px 14px;cursor:pointer}
  .btn.primary{background:var(--accent);color:#fff;border-color:var(--accent)}
  table{width:100%;border-collapse:collapse;background:#fff;margin-top:6px}
  th,td{border:1px solid var(--b);padding:10px;vertical-align:top}
  th{background:#f0f4f8}
  .meta{font-size:12px;color:var(--muted)}
  @media (max-width:900px){.grid{grid-template-columns:1fr 1fr}}
  @media (max-width:560px){.grid{grid-template-columns:1fr}}
  @media print{
    body{background:#fff}
    .wrap{border:none;margin:0;max-width:none;border-radius:0}
    .toolbar{display:none}
    th{background:#eaeaea!important;-webkit-print-color-adjust:exact;print-color-adjust:exact}
  }
</style>
</head>
<body>
<div class="wrap">
  <header>
    <div class="student">
      <label>اسم الطالب والصف والتاريخ</label>
      <input id="studentLine" placeholder="مثال: محمد | 5/أ | 1447/02/12">
    </div>
    <h1>قياس ناتج التعلم</h1>
  </header>

  <!-- القوائم المنسدلة المترابطة -->
  <div class="grid" aria-label="اختيارات مترابطة">
    <div class="field">
      <label for="unitSel">الفصل</label>
      <select id="unitSel"></select>
    </div>
    <div class="field">
      <label for="lessonSel">الدرس</label>
      <select id="lessonSel"></select>
    </div>
    <div class="field">
      <label for="loSel">ناتج التعلم</label>
      <select id="loSel"></select>
    </div>
    <div class="field">
      <label for="indSel">المؤشر</label>
      <select id="indSel"></select>
    </div>
    <div class="field">
      <label for="qTxt">السؤال</label>
      <textarea id="qTxt" placeholder="اكتب السؤال أو الصقه هنا"></textarea>
    </div>
  </div>

  <div class="toolbar">
    <button class="btn primary" onclick="addRow()">+ إضافة صف</button>
    <button class="btn" onclick="save()">حفظ</button>
    <button class="btn" onclick="load()">استرجاع</button>
    <button class="btn" onclick="exportJSON()">تصدير JSON</button>
    <label class="btn">استيراد JSON
      <input type="file" accept="application/json" style="display:none" onchange="importJSON(this.files[0])">
    </label>
    <button class="btn" onclick="window.print()">طباعة / PDF</button>
    <span class="meta" id="savedAt"></span>
  </div>

  <!-- الجدول النهائي مثل الصورة -->
  <table id="grid">
    <thead>
      <tr>
        <th>الفصل</th>
        <th>الدرس</th>
        <th>ناتج التعلم</th>
        <th>المؤشر</th>
        <th>يمكن أضع السؤال هنا كتابة أو لصقًا أو استيراد من ملف</th>
      </tr>
    </thead>
    <tbody></tbody>
  </table>

  <p class="meta">تلميح: القوائم مترابطة. بمجرد اختيار الفصل، تظهر دروسه؛ ثم ناتج التعلم المناسب؛ ثم مؤشرات هذا الدرس. بعد إدخال السؤال اضغط “إضافة صف”.</p>
</div>

<script>
/* ====== قاعدة البيانات (من الصورة) ======
   مهيكلة كالتالي: units -> lessons -> { learningOutcomes[], indicators[] }
   أضفت الفصل 1 كاملاً حسب النص المستخرج. يمكنك إضافة فصول لاحقًا بنفس البناء.
*/
const DATA = {
  "الفصل 1: القيمة المنزلية": {
    lessons: {
      "القيمة المنزلية ضمن البلايين": {
        learningOutcomes: [
          "ناتج التعلّم (1): وصف الأعداد ضمن 12 منزلة، وتمثيل هذه الأعداد، وقراءتها، وكتابتها، والمقارنة بينها، وترتيبها وتقديرها."
        ],
        indicators: [
          "المؤشر 1-1: يميز القيمة المنزلية لرقم في عدد ضمن 12 منزلة، ويمثل الأعداد باستخدام الرسوم وخط الأعداد، فيبني إلى التقدير منزلة معطاة.",
          "المؤشر 1-2: يقرأ الأعداد ضمن 12 منزلة، ويكتبها في الصور القياسية واللفظية والتحليلية."
        ]
      },
      "المقارنة بين الأعداد": {
        learningOutcomes: [
          "ناتج التعلّم (1): وصف الأعداد ضمن 12 منزلة… (المقارنة والترتيب والتقدير)."
        ],
        indicators: [
          "المؤشر 1-3: يقارن بين الأعداد ضمن 12 منزلة باستخدام الرموز (< > =) ويرتبها تصاعدياً وتنازلياً."
        ]
      },
      "تمثيل الكسور العشرية": {
        learningOutcomes: [
          "ناتج التعلّم (2): وصف الكسور العشرية، وتمثيلها، ويميز القيمة المنزلية لرقم فيها، وقراءتها، وكتابتها، والمقارنة بينها وترتيبها، وتقديرها، والتحويل بينها وبين الكسور الاعتيادية والأعداد الكسرية."
        ],
        indicators: [
          "المؤشر 2-2: يصف الكسر العشري، ويمثله باستخدام النماذج، والرسوم، وخط الأعداد، ويميز القيمة المنزلية لرقم فيه، فيقرأه ويكتبه ويمثل هذه الأعداد كنسبة مئوية ويحولها.",
          "المؤشر 2-3: يقرأ الكسور العشرية، ويكتبها في الصور القياسية واللفظية والتحليلية."
        ]
      },
      "القيمة المنزلية ضمن أجزاء الألف": {
        learningOutcomes: [
          "ناتج التعلّم (2): وصف الكسور العشرية… (حتى أجزاء الألف) والمقارنة والترتيب والتقدير والتحويل."
        ],
        indicators: [
          "المؤشر 2-4: يقارن بين الكسور العشرية، ويرتبها تصاعدياً وتنازلياً."
        ]
      },
      "مقارنة الكسور العشرية": {
        learningOutcomes: [
          "ناتج التعلّم (2): المقارنة بين الكسور العشرية وترتيبها."
        ],
        indicators: [
          "المؤشر 1-4: يقارن بين الكسور العشرية، ويرتبها تصاعدياً وتنازلياً."
        ]
      },
      "ترتيب الأعداد والكسور العشرية": {
        learningOutcomes: [
          "ناتج التعلّم (1) و(2): ترتيب الأعداد الصحيحة والكسور العشرية ضمن 12 منزلة."
        ],
        indicators: [
          "المؤشر 1-3: يقارن ويرتب الأعداد.",
          "المؤشر 2-4: يقارن ويرتب الكسور العشرية."
        ]
      }
    }
  }

  // ملاحظة: عند توفر صور/محتوى الفصول 2..x أضفها هنا بنفس البنية.
};

// مفاتيح التخزين
const KEY_ROWS = "rafid_math5_rows_v2";
const KEY_STUDENT = "rafid_math5_student_v2";
const KEY_STAMP = "rafid_math5_stamp_v2";

// عناصر الواجهة
const unitSel = document.getElementById("unitSel");
const lessonSel = document.getElementById("lessonSel");
const loSel = document.getElementById("loSel");
const indSel = document.getElementById("indSel");
const qTxt = document.getElementById("qTxt");
const tbody = document.querySelector("#grid tbody");

// تعبئة قائمة الفصول
function fillUnits(){
  unitSel.innerHTML = "";
  Object.keys(DATA).forEach(u=>{
    const opt=document.createElement("option");
    opt.value=opt.textContent=u;
    unitSel.appendChild(opt);
  });
}

// عند اختيار فصل → تعبئة الدروس
function fillLessons(){
  const unit = unitSel.value;
  lessonSel.innerHTML = "";
  loSel.innerHTML = "";
  indSel.innerHTML = "";
  if(!unit || !DATA[unit]) return;
  const lessons = Object.keys(DATA[unit].lessons);
  lessons.forEach(l=>{
    const opt=document.createElement("option");
    opt.value=opt.textContent=l;
    lessonSel.appendChild(opt);
  });
  fillLOs();
}

// عند اختيار درس → تعبئة نواتج التعلم + المؤشرات
function fillLOs(){
  const unit = unitSel.value;
  const lesson = lessonSel.value;
  loSel.innerHTML = "";
  indSel.innerHTML = "";
  if(!unit || !lesson) return;
  const obj = DATA[unit].lessons[lesson];

  obj.learningOutcomes.forEach((lo,i)=>{
    const opt=document.createElement("option");
    opt.value=opt.textContent=lo;
    loSel.appendChild(opt);
  });
  obj.indicators.forEach(ind=>{
    const opt=document.createElement("option");
    opt.value=opt.textContent=ind;
    indSel.appendChild(opt);
  });
}

// إضافة صف إلى الجدول
function addRow(){
  const row = {
    unit: unitSel.value,
    lesson: lessonSel.value,
    lo: loSel.value,
    ind: indSel.value,
    q: qTxt.value.trim()
  };
  const tr=document.createElement("tr");
  tr.innerHTML = `
    <td>${escapeHtml(row.unit)}</td>
    <td>${escapeHtml(row.lesson)}</td>
    <td>${escapeHtml(row.lo)}</td>
    <td>${escapeHtml(row.ind)}</td>
    <td>${escapeHtml(row.q)}</td>`;
  tbody.appendChild(tr);
  qTxt.value="";
  save();
}

// حفظ محلي
function save(){
  const rows=[...tbody.querySelectorAll("tr")].map(tr=>{
    const t=[...tr.children].map(td=>td.textContent);
    return {unit:t[0],lesson:t[1],lo:t[2],ind:t[3],q:t[4]};
  });
  localStorage.setItem(KEY_ROWS, JSON.stringify(rows));
  localStorage.setItem(KEY_STUDENT, document.getElementById("studentLine").value.trim());
  const stamp=new Date().toLocaleString('ar-SA');
  localStorage.setItem(KEY_STAMP, stamp);
  document.getElementById("savedAt").textContent = "آخر حفظ: "+stamp;
}

// استرجاع
function load(){
  tbody.innerHTML="";
  const rows = JSON.parse(localStorage.getItem(KEY_ROWS) || "[]");
  rows.forEach(r=>{
    const tr=document.createElement("tr");
    tr.innerHTML = `
      <td>${escapeHtml(r.unit)}</td>
      <td>${escapeHtml(r.lesson)}</td>
      <td>${escapeHtml(r.lo)}</td>
      <td>${escapeHtml(r.ind)}</td>
      <td>${escapeHtml(r.q)}</td>`;
    tbody.appendChild(tr);
  });
  document.getElementById("studentLine").value = localStorage.getItem(KEY_STUDENT)||"";
  const s = localStorage.getItem(KEY_STAMP)||"";
  document.getElementById("savedAt").textContent = s ? "آخر حفظ: "+s : "";
}

// تصدير / استيراد
function exportJSON(){
  const data = {
    student: document.getElementById("studentLine").value.trim(),
    rows: JSON.parse(localStorage.getItem(KEY_ROWS) || "[]")
  };
  const blob=new Blob([JSON.stringify(data,null,2)],{type:"application/json;charset=utf-8"});
  const a=document.createElement("a");
  a.href=URL.createObjectURL(blob);
  a.download="rafid_math5_data.json";
  a.click();
  URL.revokeObjectURL(a.href);
}
function importJSON(file){
  const fr=new FileReader();
  fr.onload=e=>{
    try{
      const data=JSON.parse(e.target.result);
      localStorage.setItem(KEY_ROWS, JSON.stringify(data.rows||[]));
      localStorage.setItem(KEY_STUDENT, data.student||"");
      load();
    }catch{ alert("ملف JSON غير صالح"); }
  };
  fr.readAsText(file,'utf-8');
}

// أدوات مساعدة
function escapeHtml(s){return (s||"").replace(/[&<>"']/g,m=>({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[m]))}

// ربط الأحداث
unitSel.addEventListener("change", fillLessons);
lessonSel.addEventListener("change", fillLOs);

// تشغيل أولي
fillUnits();        // أضف الفصول
fillLessons();      // ثم الدروس لأول فصل
load();             // حمّل أي بيانات قديمة
</script>
</body>
</html>