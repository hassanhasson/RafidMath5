<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>RafidGrade4 – قياس ناتج التعلم (رابع ابتدائي)</title>
<style>
  :root{--b:#d9dde3;--bg:#fff;--muted:#666;--accent:#0b5cad}
  *{box-sizing:border-box}
  body{margin:0;background:#f6f7f9;font-family:"Tahoma","Cairo",system-ui}
  .wrap{max-width:1150px;margin:28px auto;padding:16px;background:#fff;border:1px solid var(--b);border-radius:10px}
  header{border-bottom:1px solid var(--b);padding-bottom:12px;margin-bottom:14px}
  h1{margin:0;text-align:center}
  .student-grid{display:grid;grid-template-columns:1fr 1fr 1fr;gap:10px;margin-top:12px}
  .field{display:flex;flex-direction:column;gap:6px}
  .field label{font-size:12px;color:#222}
  input,select,textarea{border:1px solid var(--b);border-radius:8px;padding:10px;background:#fff;font-size:14px}
  .grid{display:grid;grid-template-columns:repeat(4,1fr);gap:10px;margin:16px 0 6px}
  .qbox{margin-top:8px}
  .q-actions{display:flex;gap:8px;align-items:center;margin-top:6px;flex-wrap:wrap}
  .q-actions .meta{font-size:12px;color:var(--muted)}
  .toolbar{display:flex;flex-wrap:wrap;gap:8px;margin:14px 0}
  .btn{border:1px solid var(--b);background:#fff;border-radius:8px;padding:10px 14px;cursor:pointer}
  .btn.primary{background:var(--accent);color:#fff;border-color:var(--accent)}
  table{width:100%;border-collapse:collapse;background:#fff}
  th,td{border:1px solid var(--b);padding:10px;vertical-align:top}
  th{background:#f0f4f8}
  .meta{font-size:12px;color:var(--muted)}
  details{background:#fafafa;border:1px solid var(--b);border-radius:8px;padding:8px}
  summary{cursor:pointer;font-weight:bold}
  pre{white-space:pre-wrap;direction:rtl;font-family:inherit;margin:8px 0 0}
  .muted{color:#777}
  .pair{display:flex;gap:8px;flex-wrap:wrap}

  /* للطباعة: صفحتان */
  @media print {
    body{background:#fff}
    .wrap{border:none;margin:0;max-width:none;border-radius:0}
    .toolbar,.q-actions,details{display:none}

    /* الصفحة الأولى: كل شيء حتى #gridPage */
    #gridPage{page-break-after:always;}

    /* الصفحة الثانية: السؤال فقط */
    #questionPage{display:block !important;}
    #questionPage h2{margin-top:0;text-align:center}
    #questionPage .q-print{
      margin-top:20px;font-size:20px;line-height:1.9;white-space:pre-wrap;
      border:1px solid #000;padding:16px;min-height:400px
    }
  }
</style>
</head>
<body>
<div class="wrap">

  <!-- ===== الصفحة الأولى (البيانات + الجدول) ===== -->
  <div id="gridPage">
    <header>
      <h1>قياس ناتج التعلم – الصف الرابع</h1>
      <div class="student-grid" aria-label="بيانات الطالب">
        <div class="field">
          <label for="studentName">اسم الطالب</label>
          <input id="studentName" placeholder="مثال: محمد أحمد">
        </div>
        <div class="field">
          <label for="className">الصف/الشعبة</label>
          <input id="className" placeholder="مثال: 4/ب">
        </div>
        <div class="field">
          <label for="dateVal">التاريخ</label>
          <input id="dateVal" type="date">
        </div>
      </div>
    </header>

    <!-- القوائم المنسدلة -->
    <div class="grid" aria-label="اختيارات مترابطة">
      <div class="field">
        <label for="unitSel">الفصل</label>
        <select id="unitSel"></select>
      </div>
      <div class="field">
        <label for="lessonSel">الدرس</label>
        <select id="lessonSel"></select>
      </div>
      <div class="field">
        <label for="loSel">ناتج التعلم</label>
        <select id="loSel"></select>
      </div>
      <div class="field">
        <label for="indSel">المؤشر</label>
        <select id="indSel"></select>
      </div>
    </div>

    <!-- خانة السؤال أسفل + استيراد من ملف -->
    <div class="qbox">
      <div class="field">
        <label for="qTxt">السؤال</label>
        <textarea id="qTxt" placeholder="اكتب السؤال أو الصقه هنا"></textarea>
      </div>
      <div class="q-actions">
        <div class="pair">
          <label class="btn">استيراد سؤال من ملف
            <input id="qFile" type="file" accept=".txt,.md,.rtf,.html,text/plain" style="display:none">
          </label>
          <label class="btn">استيراد نص المصدر (TXT)
            <input id="rawFile" type="file" accept=".txt,text/plain" style="display:none">
          </label>
        </div>
        <button class="btn" id="reparseBtn" title="إعادة تفكيك النص إلى فصول ودروس">إعادة تفكيك النص</button>
        <span class="meta">لو الملف PDF صورة: حوّله نصًا (OCR) ثم استورده هنا، وسيتم تفكيكه إلى (فصل → درس → ناتج → مؤشر).</span>
      </div>
    </div>

    <div class="toolbar">
      <button class="btn primary" onclick="addRow()">+ إضافة صف</button>
      <button class="btn" onclick="save()">حفظ</button>
      <button class="btn" onclick="load()">استرجاع</button>
      <button class="btn" onclick="exportJSON()">تصدير JSON</button>
      <label class="btn">استيراد JSON
        <input id="jsonIn" type="file" accept="application/json" style="display:none">
      </label>
      <button class="btn" onclick="window.print()">طباعة / PDF</button>
      <span class="meta" id="savedAt"></span>
    </div>

    <!-- الجدول النهائي -->
    <table id="grid">
      <thead>
        <tr>
          <th>اسم الطالب</th>
          <th>الصف</th>
          <th>التاريخ</th>
          <th>الفصل</th>
          <th>الدرس</th>
          <th>ناتج التعلم</th>
          <th>المؤشر</th>
          <th>السؤال</th>
        </tr>
      </thead>
      <tbody></tbody>
    </table>

    <p class="meta">اختر الفصل ثم الدرس ثم ناتج التعلم ثم المؤشر. أضف سؤالك ثم “إضافة صف”.</p>

    <!-- النص الأصلي المستخرج للفصول لمراجعة يدوية -->
    <details style="margin-top:12px">
      <summary>إظهار النص الأصلي (مصدر OCR) للمطابقة/التصحيح</summary>
      <p class="muted">هذا النص هو المصدر الخام (يمكنك لصقه أو استيراده). عند الضغط على "إعادة تفكيك النص" سيتم توليد القوائم منه.</p>
      <textarea id="rawTextArea" style="width:100%;min-height:200px"></textarea>
      <pre id="rawDump" class="muted" style="display:none"></pre>
    </details>
  </div><!-- /gridPage -->

  <!-- ===== الصفحة الثانية (السؤال فقط للطباعة) ===== -->
  <div id="questionPage" style="display:none">
    <h2>السؤال</h2>
    <div class="q-print" id="qPrint"></div>
  </div>

</div><!-- /.wrap -->

<script>
/* ========= RAW TEXT: ضع هنا نص الـ OCR إن رغبت افتراضياً ========= */
let RAW_TEXT = ""; // يمكن تركه فارغًا ثم استيراده كملف TXT أو لصقه في المربع داخل الصفحة.

/* ========= محلّل تلقائي لتقسيم النص إلى: فصل → دروس → LO → مؤشرات =========
   ملاحظات OCR المحتملة:
   - "الفصل" قد تظهر سليمة أو مع مسافات.
   - "ناتج التعلم" قد تظهر "ناتج" أو "جتان" (معكوسة) أو ناقصة.
   - "المؤشر" قد تظهر "المؤشر" أو ملتبسة؛ نلتقط أيضًا سطور مرقّمة 1- ، 2- ... كبديل.
*/
function parseToData(raw){
  const data = {};
  const cleaned = (raw||"")
      .replace(/\u200f|\u200e/g,'')
      .replace(/\r/g,'')
      .replace(/[ \t]+\n/g,"\n")
      .replace(/[ \t]+/g,' ')
      .trim();

  if(!cleaned){ return defaultEmptyDATA(); }

  // قسّم إلى فصول: "الفصل X" (يدعم أرقام عربية وهندية)
  const chapterRegex = /(الفصل)\s*([0-9\u0660-\u0669]+)/g;
  const parts = [];
  let m, lastIndex=0;
  while((m = chapterRegex.exec(cleaned)) !== null){
    if(m.index > lastIndex){
      parts.push({title: null, body: cleaned.slice(lastIndex, m.index)});
    }
    parts.push({title: `الفصل ${toArabicDigits(m[2])}`, body: ""});
    lastIndex = chapterRegex.lastIndex;
  }
  if(lastIndex < cleaned.length){
    parts.push({title: null, body: cleaned.slice(lastIndex)});
  }

  // دمج الأجسام مع عناوينها
  const chapters = [];
  for(let i=0;i<parts.length;i++){
    if(parts[i].title){
      let body = "";
      // اجمع النص حتى الفصل التالي
      for(let j=i+1;j<parts.length && !parts[j].title;j++){ body += parts[j].body; i=j; }
      chapters.push({title: parts[i].title, body: body.trim()});
    }
  }
  // لو ما تعرف على "الفصل" سنعتبر كل النص فصل واحد
  if(chapters.length===0){
    chapters.push({title: "الفصل 1", body: cleaned});
  }

  chapters.forEach(ch=>{
    const unitName = ch.title;
    data[unitName] = { lessons: {}, _raw: ch.body };

    // استنتاج عناوين الدروس: سطور تحتوي كلمات شائعة للدروس
    const lines = ch.body.split(/\n/).map(s=>s.trim()).filter(Boolean);
    const lessonIndices = [];
    const lessonTitles = [];

    lines.forEach((ln, idx)=>{
      if(/(?:الدرس|أنماط|خطة|استقصاء|تمثيل|ترتيب|تقريب|تقدير|الجمع|الطرح|الضرب|القسمة|الكسور|الدوال|العبارات|المعادلات)/.test(ln)
         && ln.length > 4){
        lessonIndices.push(idx);
        lessonTitles.push(normalizeLessonTitle(ln));
      }
    });

    // لا توجد دروس واضحة → درس عام
    if(lessonIndices.length===0){
      const block = lines.join("\n");
      data[unitName].lessons["(نص هذا الفصل)"] = {
        learningOutcomes: splitLO(block),
        indicators: splitIndicators(block),
        _raw: block
      };
      return;
    }

    // قصّ كل درس بمؤشره
    lessonIndices.forEach((startIdx, k)=>{
      const endIdx = (k < lessonIndices.length-1) ? lessonIndices[k+1] : lines.length;
      const block = lines.slice(startIdx, endIdx).join("\n");
      const title = lessonTitles[k] || `الدرس ${k+1}`;
      data[unitName].lessons[title] = {
        learningOutcomes: splitLO(block),
        indicators: splitIndicators(block),
        _raw: block
      };
    });
  });

  return data;
}

function normalizeLessonTitle(t){
  return t.replace(/[^\u0600-\u06FF0-9\s:،\-]/g,'').replace(/\s+/g,' ').trim().slice(0,90);
}

function splitLO(block){
  // التقط مقاطع تبدأ بكلمات ناتج التعلم المحتملة
  const loLines = [];
  block.split(/\n/).forEach(l=>{
    if(/(?:ناتج(?:\s*التعل)|ناتج|جتان)/.test(l)) loLines.push(cleanLine(l));
  });
  if(loLines.length) return loLines;

  // بديل: قص حسب نمط
  const parts = block.split(/(?:(?:ناتج|جتان).{0,10}(?:التعل|ملتع))/).map(s=>s.trim()).filter(Boolean);
  if(parts.length>1){ return parts.slice(1).map(cleanLine); }

  const all = extractAllLO(block);
  return all ? [all] : ["(لم يُلتقط ناتج تعلم واضح من هذا الدرس – راجع النص الأصلي)"];
}

function extractAllLO(txt){
  const lines = txt.split(/\n/).filter(Boolean);
  const lo = lines.filter(l=>/(?:ناتج|جتان|ناتج التعل)/.test(l)).join(' ').trim();
  return lo || "";
}

function splitIndicators(block){
  const inds=[];
  block.split(/\n/).forEach(l=>{
    if(/(?:المؤشر|رشؤلما)/.test(l)) inds.push(cleanLine(l));
  });
  // بديل: أسطر مرقمة 1- ، 2- … كـ مؤشرات
  if(inds.length===0){
    const numbered = block.match(/(?:^|\n)\s*(\d{1,2}\s*[-–]\s*.+?)(?=\n|$)/g);
    if(numbered) numbered.forEach(x=>inds.push(cleanLine(x)));
  }
  return inds.length? inds : ["(لم تُلتقط مؤشرات واضحة — راجع النص الأصلي)"];
}

function cleanLine(s){
  return (s||"").replace(/[^\u0600-\u06FF0-9\s:،().=<>\-]/g,'').replace(/\s+/g,' ').trim();
}

function toArabicDigits(str){
  return String(str).replace(/\d/g, d=> "٠١٢٣٤٥٦٧٨٩"[d]);
}
function defaultEmptyDATA(){
  return {"الفصل 1":{lessons:{}}};
}

/* ========= بناء DATA من RAW_TEXT ========= */
let DATA = parseToData(RAW_TEXT);

/* ======= التخزين والواجهة ======= */
const KEY_ROWS="rafid_g4_rows_v2";
const KEY_META="rafid_g4_meta_v2";
const KEY_STAMP="rafid_g4_stamp_v2";

const unitSel=document.getElementById("unitSel");
const lessonSel=document.getElementById("lessonSel");
const loSel=document.getElementById("loSel");
const indSel=document.getElementById("indSel");
const qTxt=document.getElementById("qTxt");
const qFile=document.getElementById("qFile");
const rawFile=document.getElementById("rawFile");
const reparseBtn=document.getElementById("reparseBtn");
const rawTextArea=document.getElementById("rawTextArea");
const tbody=document.querySelector("#grid tbody");
const studentName=document.getElementById("studentName");
const className=document.getElementById("className");
const dateVal=document.getElementById("dateVal");

/* تعبئة القوائم */
function fillUnits(){
  unitSel.innerHTML="";
  Object.keys(DATA).forEach(u=>{
    if(u.startsWith("الفصل")){
      const o=document.createElement("option");o.value=o.textContent=u;unitSel.appendChild(o);
    }
  });
  if(!unitSel.value){
    const o=document.createElement("option");o.value=o.textContent="(لا توجد فصول بعد)";unitSel.appendChild(o);
  }
}
function fillLessons(){
  const unit=unitSel.value;
  lessonSel.innerHTML=""; loSel.innerHTML=""; indSel.innerHTML="";
  if(!unit || !DATA[unit]) return;
  const lessons = Object.keys(DATA[unit].lessons);
  if(lessons.length===0){
    const o=document.createElement("option");o.value=o.textContent="(نص هذا الفصل)";lessonSel.appendChild(o);
  }else{
    lessons.forEach(l=>{
      const o=document.createElement("option");o.value=o.textContent=l;lessonSel.appendChild(o);
    });
  }
  fillLOs();
}
function fillLOs(){
  const unit=unitSel.value, lesson=lessonSel.value;
  loSel.innerHTML=""; indSel.innerHTML="";
  if(!unit||!lesson) return;
  const L = (DATA[unit].lessons[lesson]) || {learningOutcomes:["(لا يوجد ناتج محدد)"],indicators:["(لا يوجد مؤشر محدد)"]};
  L.learningOutcomes.forEach(lo=>{
    const o=document.createElement("option");o.value=o.textContent=lo;loSel.appendChild(o);
  });
  L.indicators.forEach(ind=>{
    const o=document.createElement("option");o.value=o.textContent=ind;indSel.appendChild(o);
  });
}

/* إضافة صف */
function addRow(){
  const row={
    name: studentName.value.trim(),
    cls: className.value.trim(),
    date: dateVal.value || "",
    unit: unitSel.value,
    lesson: lessonSel.value,
    lo: loSel.value,
    ind: indSel.value,
    q: qTxt.value.trim()
  };
  const tr=document.createElement("tr");
  tr.innerHTML=`
    <td>${escapeHtml(row.name)}</td>
    <td>${escapeHtml(row.cls)}</td>
    <td>${escapeHtml(row.date)}</td>
    <td>${escapeHtml(row.unit)}</td>
    <td>${escapeHtml(row.lesson)}</td>
    <td>${escapeHtml(row.lo)}</td>
    <td>${escapeHtml(row.ind)}</td>
    <td>${escapeHtml(row.q)}</td>`;
  tbody.appendChild(tr);
  save();
  qTxt.value="";
}

/* حفظ/استرجاع */
function save(){
  const rows=[...tbody.querySelectorAll("tr")].map(tr=>{
    const t=[...tr.children].map(td=>td.textContent);
    return {name:t[0],cls:t[1],date:t[2],unit:t[3],lesson:t[4],lo:t[5],ind:t[6],q:t[7]};
  });
  localStorage.setItem(KEY_ROWS, JSON.stringify(rows));
  localStorage.setItem(KEY_META, JSON.stringify({
    name:studentName.value.trim(), cls:className.value.trim(), date:dateVal.value||""
  }));
  const stamp=new Date().toLocaleString('ar-SA');
  localStorage.setItem(KEY_STAMP, stamp);
  document.getElementById("savedAt").textContent="آخر حفظ: "+stamp;
}
function load(){
  tbody.innerHTML="";
  const rows=JSON.parse(localStorage.getItem(KEY_ROWS)||"[]");
  rows.forEach(r=>{
    const tr=document.createElement("tr");
    tr.innerHTML=`
      <td>${escapeHtml(r.name)}</td>
      <td>${escapeHtml(r.cls)}</td>
      <td>${escapeHtml(r.date)}</td>
      <td>${escapeHtml(r.unit)}</td>
      <td>${escapeHtml(r.lesson)}</td>
      <td>${escapeHtml(r.lo)}</td>
      <td>${escapeHtml(r.ind)}</td>
      <td>${escapeHtml(r.q)}</td>`;
    tbody.appendChild(tr);
  });
  const meta=JSON.parse(localStorage.getItem(KEY_META)||"{}");
  studentName.value=meta.name||""; className.value=meta.cls||""; dateVal.value=meta.date||"";
  const s=localStorage.getItem(KEY_STAMP)||""; document.getElementById("savedAt").textContent=s?("آخر حفظ: "+s):"";
}

/* تصدير/استيراد JSON */
function exportJSON(){
  const payload={
    meta:{name:studentName.value.trim(),cls:className.value.trim(),date:dateVal.value||""},
    rows:JSON.parse(localStorage.getItem(KEY_ROWS)||"[]"),
    dataSnapshot: DATA
  };
  const blob=new Blob([JSON.stringify(payload,null,2)],{type:"application/json;charset=utf-8"});
  const a=document.createElement("a"); a.href=URL.createObjectURL(blob); a.download="rafid_grade4_data.json"; a.click();
  URL.revokeObjectURL(a.href);
}
document.getElementById("jsonIn").addEventListener("change", (ev)=>{
  const file=ev.target.files[0]; if(!file) return;
  const fr=new FileReader();
  fr.onload=e=>{
    try{
      const d=JSON.parse(e.target.result);
      if(d.dataSnapshot){ DATA=d.dataSnapshot; }
      localStorage.setItem(KEY_ROWS, JSON.stringify(d.rows||[]));
      localStorage.setItem(KEY_META, JSON.stringify(d.meta||{}));
      fillUnits(); fillLessons();
      load();
    }catch{ alert("ملف JSON غير صالح"); }
  };
  fr.readAsText(file,'utf-8');
});

/* استيراد سؤال من ملف نصي */
qFile.addEventListener("change", ()=>{
  const f=qFile.files[0]; if(!f) return;
  const fr=new FileReader();
  fr.onload=e=>{ qTxt.value=(qTxt.value? qTxt.value+"\n":"")+e.target.result; };
  fr.readAsText(f,'utf-8');
});

/* استيراد نص المصدر (TXT) + إعادة التفكيك */
rawFile.addEventListener("change", ()=>{
  const f=rawFile.files[0]; if(!f) return;
  const fr=new FileReader();
  fr.onload=e=>{
    RAW_TEXT = e.target.result || "";
    rawTextArea.value = RAW_TEXT;
    rebuildDATAFromRAW();
  };
  fr.readAsText(f,'utf-8');
});
reparseBtn.addEventListener("click", rebuildDATAFromRAW);
function rebuildDATAFromRAW(){
  RAW_TEXT = rawTextArea.value || RAW_TEXT || "";
  DATA = parseToData(RAW_TEXT);
  fillUnits(); fillLessons();
}

/* تجهيز صفحة السؤال عند الطباعة (الصفحة الثانية) */
function prepareQuestionPage(){
  document.getElementById("qPrint").textContent =
    qTxt.value.trim()
    || "(لم تتم كتابة سؤال)";
}
window.addEventListener("beforeprint", prepareQuestionPage);

/* أدوات مساعدة */
function escapeHtml(s){return (s||"").replace(/[&<>"']/g,m=>({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[m]))}

/* تشغيل أولي */
document.getElementById("savedAt").textContent="";
rawTextArea.value = RAW_TEXT; // لو عندك نص افتراضي
fillUnits(); fillLessons(); load();
</script>
</body>
</html>
